@page "/results"
@rendermode InteractiveServer
@using Game.Models
@using Game.Services
@using Microsoft.AspNetCore.WebUtilities

@inject GameService GameService
@inject GameState GameState
@inject NavigationManager Navigation

<PageTitle>Félidő</PageTitle>

<div class="main-container">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border"></div>
            <p>Dobpergés...</p>
        </div>
    }
    else if (GameState.CurrentPlayer is not null)
    {
        <section class="summary">
            <h1>Gratulálunk!</h1>
            <p>A játék felénél jársz. Vettük a fáradságot, és eddigi fáradozásaidat kiértékeltük, hogy lásd, hogyan teljesítettél eddig.</p>
        </section>

        <section class="stat-evaluation">
            @foreach (var stat in GameState.CurrentPlayer!.Stats.AsDictionary())
            {
                var iconPath = $"src/Icons/{stat.Value.Canonical.ToLower()}.png";
                var cssClass = $"player-stat stat-{stat.Value.Canonical.ToLower()}";

                <div class="evaluation-card">
                    <div class="@cssClass">
                        <div class="shine" />
                        <img src="@iconPath" class="stat-icon" />
                        <span class="value">@stat.Value.Value</span>
                    </div>
                    <h3>@stat.Key</h3>
                    <p>A kreativitás területén kevés pontot gyűjtöttél, ami arra utalhat, hogy hajlamos vagy a dolgokat inkább egy, már ismert módon megközelíteni. Ennek hátrányát leggyakrabban akkor érezheted, amikor valami kizökkent a megszokottból, az oktatási gyakorlatodban korlátozva érzed magad, esetleg túlzott energiát követel tőled vagy egyenesen lehetetlennek tűnik számodra valami. Érdemes megfigyelni, hogy mások milyen megoldásokat alkalmaznak hasonló helyzetekre; esetleg megosztani az ötleteidet olyanokkal, akik új perspektívából inspirálhatnak; illetve azonosítani önmagadban azokat a színtereket, akár hétköznapi példákat, ahol kreatívnak érzed magad.</p>
                </div>
            }
        </section>

        <div class="continue-wrapper">
            <button class="fancy-light" type="button" @onclick="ContinueAsync" disabled="@isProcessing">
                <div class="shine" />
                @(isProcessing ? "Máris..." : "Tovább →")
            </button>
        </div>
    }
</div>

@code {
    private Player? player;
    private bool isLoading = true;
    private bool isProcessing;

    protected override async Task OnInitializedAsync()
    {
        await EnsurePlayerAsync();
        isLoading = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task EnsurePlayerAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (!QueryHelpers.ParseQuery(uri.Query).TryGetValue("playerId", out var playerIdValue) || !Guid.TryParse(playerIdValue, out var playerId))
        {
            Navigation.NavigateTo("/setup", true);
            return;
        }

        player = await GameService.GetPlayerAsync(playerId);
        if (player is null)
        {
            Navigation.NavigateTo("/setup", true);
            return;
        }

        GameState.SetPlayer(player);
    }

    private async Task ContinueAsync()
    {
        if (player is null || isProcessing)
        {
            return;
        }

        isProcessing = true;

        try
        {
            var currentSituation = await GameService.GetCurrentSituationAsync(player);

            if (currentSituation?.NextSituationId is not null)
            {
                player = await GameService.ContinueFromHalftimeAsync(player, currentSituation.NextSituationId.Value);
                GameState.UpdatePlayer(player);
                Navigation.NavigateTo($"/play?playerId={player.Id}");
            }
        }
        finally
        {
            isProcessing = false;
        }
    }
}