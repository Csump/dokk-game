@page "/play"
@rendermode InteractiveServer
@using Game.Models
@using Game.Services
@using Game.Components.Shared

@inject GameState GameState
@inject GameService GameService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>HEDGIE</PageTitle>

@if (GameState.HasActiveSession && GameState.CurrentPlayer is not null)
{
    <PlayerStatsBar Stats="@GameState.CurrentPlayer.Stats" />
}

<div class="main-container">
    @if (player is null)
    {
        <div class="alert alert-info">
            Nincs aktív játékod. <a href="/setup">Alkoss egy karaktert</a> a játék megkezdéséhez!
        </div>
    }
    else if (isLoading || currentSituation is null)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status"></div>
            <p class="mt-3 text-muted">Szituáció előkészítése...</p>
        </div>
    }
    else
    {
        <div class="situation" Situation="@currentSituation">

            @if (!string.IsNullOrWhiteSpace(currentSituation.IllustrationUrl))
            {
                <img src="./src/Situations/@GetIllustrationUrl(currentSituation.IllustrationUrl)"
                     class="situation-illustration"
                     onerror="this.onerror=null; this.src='./src/Situations/hedgie_terulo.png';" />
			}
            else
            {
                <img src="./src/Situations/@GetDefaultIllustrationUrl()"
                     class="situation-illustration"
                     onerror="this.onerror=null; this.src='./src/Situations/hedgie_terulo.png';" />
            }

            <div class="situation-text">
                <p class="title">@currentSituation.Title</p>

                @if (currentSituation.Text is not null && currentSituation.Text.Length > 0)
                {
                    <p class="text">@currentSituation.Text</p>
                }
            </div>

            @if (currentSituation.Type == SituationType.Info || currentSituation.Type == SituationType.Minigame)
            {
                <div style="height: 12vh;"></div>
                <div class="continue-wrapper">
                    <button class="fancy-light" type="button" @onclick="ProceedAsync" disabled="@isProcessing">
                        <div class="shine" />
                        @(isProcessing ? "Máris..." : "Tovább →")
                    </button>
                </div>
            }
            else if (currentSituation.Type == SituationType.Decision || currentSituation.Type == SituationType.Special)
            {
                <div class="choice-list decision-list">
                    @foreach (var choice in currentSituation.Choices)
                    {
                        var isChoiceTaken = IsChoiceTaken(choice);
                        <div class="choice-button-container">
                            @if (!string.IsNullOrWhiteSpace(choice.Link))
                            {
                                <button class="link-button" @onclick="() => OpenLink(choice.Link)" @onclick:stopPropagation="true">
                                    Részletek ↗
                                </button>
                            }
                            <button class="choice-button" @onclick="() => HandleChoiceAsync(choice)" disabled="@isChoiceTaken">
                                <div class="shine" />
                                <span class="choice-text">@choice.Text</span>
                            </button>
                        </div>
                    }
                </div>
            }
            else if (currentSituation.Type == SituationType.Conversation)
            {
                <div class="choice-list conversation-list">
                    @foreach (var choice in currentSituation.Choices)
                    {
                        var isChoiceTaken = IsChoiceTaken(choice);
                        <button class="choice-button" @onclick="() => HandleChoiceAsync(choice)" disabled="@isChoiceTaken">
                            <div class="shine" />
                            <span class="choice-text">@choice.Text</span>
                        </button>
                    }
                </div>
            }
        </div>
    }

</div>

@code {
    private Player? player;
    private Situation? currentSituation;
    private bool isLoading = true;
    private bool isProcessing;

    private bool HasChoices => currentSituation?.Choices?.Any() == true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await EnsurePlayerAsync();
            if (player is not null)
            {
                await UpdateFaviconAsync();
                await LoadSituationAsync();
            }
            else
            {
                isLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task UpdateFaviconAsync()
    {
        if (player is not null)
        {
            var iconUrl = await JS.InvokeAsync<string>("faviconHelper.getCharacterIconUrl", 
                (int)player.Type.Gender, 
                (int)player.Type.Age);
            await JS.InvokeVoidAsync("faviconHelper.changeFavicon", iconUrl);
        }
    }

    private async Task EnsurePlayerAsync()
    {
        if (GameState.CurrentPlayer is not null)
        {
            player = GameState.CurrentPlayer;
            return;
        }

        if (await GameState.RestorePlayerAsync())
        {
            player = GameState.CurrentPlayer;
            return;
        }


    }

    private async Task LoadSituationAsync()
    {
        if (player is null)
        {
            return;
        }

        isLoading = true;
        var situation = await GameService.GetCurrentSituationAsync(player);
        currentSituation = situation;
        isLoading = false;
        await InvokeAsync(StateHasChanged);
    }

    private bool IsChoiceTaken(Choice choice)
    {
        return player?.Decisions?.Any(d => d.ChoiceId == choice.Id) ?? false;
    }

    private void CheckCheckpoint()
    {
        if (currentSituation is null || currentSituation?.IsHalftime == true)
        {
            Navigation.NavigateTo("/results");
            return;
        }

        if (currentSituation?.IsTerminal == true)
        {
            Navigation.NavigateTo("/leaderboard");
            return;
        }
    }

    private async Task HandleChoiceAsync(Choice choice)
    {
        if (player is null || isProcessing || IsChoiceTaken(choice))
        {
            return;
        }

        isProcessing = true;

        try
        {
            var (success, updatedPlayer, errorMessage) = await GameService.TakeChoiceAsync(player, choice.Id);

            if (success)
            {
                player = updatedPlayer;
                await GameState.UpdatePlayerAsync(player);

                CheckCheckpoint();
                await LoadSituationAsync();
            }
            else
            {
                Console.WriteLine($"Failed to take choice: {errorMessage}");
                await LoadSituationAsync();
            }
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task ProceedAsync()
    {
        if (player is null || isProcessing || currentSituation is null)
        {
            return;
        }

        isProcessing = true;

        try
        {
            var (success, updatedPlayer, errorMessage) = await GameService.ProceedAsync(player, currentSituation.Id);

            if (success)
            {
                player = updatedPlayer;
                await GameState.UpdatePlayerAsync(player);

                CheckCheckpoint();
                await LoadSituationAsync();
            }
            else
            {
                Console.WriteLine($"Failed to proceed: {errorMessage}");
                await LoadSituationAsync();
            }
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void GoToResults()
    {
        if (player is not null)
        {
            Navigation.NavigateTo("/results");
            StateHasChanged();
        }
    }

    private string GetDefaultIllustrationUrl()
    {
        if (player is null)
        {
            return "hedgie_terulo.png";
        }

        switch (player.Type.Gender, player.Type.Age)
        {
            case (Gender.Female, Age.Young):
                return "logo_terulominta_zsofi.png";
            case (Gender.Female, Age.Old):
                return "logo_terulominta_gabi.png";
            case (Gender.Male, Age.Young):
                return "logo_terulominta_mate.png";
            case (Gender.Male, Age.Old):
                return "logo_terulominta_ivan.png";
            default:
                return "hedgie_terulo.png";
        }
    }

    private string GetIllustrationUrl(string originalUrl)
    {
        if (player is null)
        {
            return originalUrl;
        }

        if (originalUrl == "hedgie_terulo.png")
        {
            return GetDefaultIllustrationUrl();
        }

        if (originalUrl == "osszeallt_a_csapat.png")
        {
            switch (player.Type.Gender, player.Type.Age)
            {
                case (Gender.Female, Age.Young):
                    return "osszeallt_a_csapat_zsofi.png";
                case (Gender.Female, Age.Old):
                    return "osszeallt_a_csapat_gabi.png";
                case (Gender.Male, Age.Young):
                    return "osszeallt_a_csapat_mate.png";
                case (Gender.Male, Age.Old):
                    return "osszeallt_a_csapat_ivan.png";
                default:
                    return "osszeallt_a_csapat.png";
            }
        }

        return originalUrl;
    }

    private async Task OpenLink(string link)
    {
        await JS.InvokeVoidAsync("open", link, "_blank");
    }
}

