@page "/play"
@rendermode InteractiveServer
@using Game.Models
@using Game.Services
@using Game.Components.Shared
@using Microsoft.AspNetCore.WebUtilities

@inject GameState GameState
@inject GameService GameService
@inject NavigationManager Navigation
@inject ILogger<GameBoard> Logger

<PageTitle>Gameplay</PageTitle>

<div class="main-container">
    @if (player is null)
    {
        <div class="alert alert-info">
            Nincs aktív játékod. <a href="/setup">Alkoss egy karaktert</a> a játék megkezdéséhez!
        </div>
    }
    else if (isLoading || currentSituation is null)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status"></div>
            <p class="mt-3 text-muted">Szituáció előkészítése...</p>
        </div>
    }
    else
    {
        <div class="situation" Situation="@currentSituation">

            @if (currentSituation.IllustrationUrl is not null && currentSituation.IllustrationUrl.Length > 0)
            {
                <img src="@currentSituation.IllustrationUrl" alt="Illusztráció" class="situation-illustration" />
			}

            <div class="situation-text">
                <p class="title">@currentSituation.Title</p>

                @if (currentSituation.Text is not null && currentSituation.Text.Length > 0)
                {
                    <p class="text">@currentSituation.Text</p>
                }
            </div>

            @if (currentSituation is Minigame)
            {
                <MinigamePlaceholder />
            }
            else if (currentSituation is Info)
            {
                <div class="continue-wrapper">
                    <button class="fancy-light" type="button" @onclick="ProceedAsync" disabled="@isProcessing">
                        <div class="shine" />
                        @(isProcessing ? "Máris..." : "Tovább →")
                    </button>
                </div>
            }
            else if (currentSituation is Decision)
            {
                <div class="choice-list decision-list">
                    @foreach (var choice in currentSituation.Choices)
                    {
                        <button class="choice-button" @onclick="() => HandleChoiceAsync(choice)">
                            <div class="shine" />
                            <span class="choice-text">@choice.Text</span>
                        </button>
                    }
                </div>
            }
            else if (currentSituation is Conversation)
            {
                <div class="choice-list conversation-list">
                    @foreach (var choice in currentSituation.Choices)
                    {
                        <button class="choice-button" @onclick="() => HandleChoiceAsync(choice)">
                            <div class="shine" />
                            <span class="choice-text">@choice.Text</span>
                        </button>
                    }
                </div>
            }
            else
            {
                <button class="fancy-light" type="button" @onclick="GoToResults" disabled="@isProcessing">
                    <div class="shine" />
                    Eredmények megtekintése
                </button>
            }
        </div>
    }

</div>

@code {
    private Player? player;
    private Situation? currentSituation;
    private bool isLoading = true;
    private bool isProcessing;

    private bool HasChoices => currentSituation?.Choices?.Any() == true;

    protected override async Task OnInitializedAsync()
    {
        await EnsurePlayerAsync();
        if (player is not null)
        {
            await LoadSituationAsync();
        }
    }

    private async Task EnsurePlayerAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (!QueryHelpers.ParseQuery(uri.Query).TryGetValue("playerId", out var playerIdValue) || !Guid.TryParse(playerIdValue, out var playerId))
        {
            Navigation.NavigateTo("/setup", true);
            return;
        }

        player = await GameService.GetPlayerAsync(playerId);
        if (player is null)
        {
            Navigation.NavigateTo("/setup", true);
            return;
        }

        GameState.SetPlayer(player);
    }

    private async Task LoadSituationAsync()
    {
        if (player is null)
        {
            return;
        }

        isLoading = true;
        var situation = await GameService.GetCurrentSituationAsync(player);
        currentSituation = situation;
        isLoading = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleChoiceAsync(Choice choice)
    {
        if (player is null || isProcessing)
        {
            return;
        }

        isProcessing = true;

        try
        {
            player = await GameService.TakeChoiceAsync(player, choice.Id);
            GameState.UpdatePlayer(player);

            if (choice.NextSituationId == Guid.Empty || currentSituation?.IsTerminal == true || player.CurrentSituationId == Guid.Empty)
            {
                Navigation.NavigateTo($"/results?playerId={player.Id}");
                return;
            }

            await LoadSituationAsync();
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task ProceedAsync()
    {
        if (player is null || isProcessing || currentSituation is null)
        {
            return;
        }

        isProcessing = true;

        try
        {
            player = await GameService.ProceedAsync(player, currentSituation.Id);
            GameState.UpdatePlayer(player);

            if (player.CurrentSituationId == Guid.Empty)
            {
                Navigation.NavigateTo($"/results?playerId={player.Id}");
                return;
            }

            await LoadSituationAsync();
            
            if (currentSituation?.IsTerminal == true)
            {
                Navigation.NavigateTo($"/results?playerId={player.Id}");
                return;
            }
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void GoToResults()
    {
        if (player is not null)
        {
            Navigation.NavigateTo($"/results?playerId={player.Id}");
        }
    }
}

