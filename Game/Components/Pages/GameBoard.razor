@page "/play"
@rendermode InteractiveServer
@using Game.Models
@using Game.Services
@using Game.Components.Shared

@inject GameState GameState
@inject GameService GameService
@inject NavigationManager Navigation

<PageTitle>Gameplay</PageTitle>

@if (GameState.HasActiveSession && GameState.CurrentPlayer is not null)
{
    <PlayerStatsBar Stats="@GameState.CurrentPlayer.Stats" />
}

<div class="main-container">
    @if (player is null)
    {
        <div class="alert alert-info">
            Nincs aktív játékod. <a href="/setup">Alkoss egy karaktert</a> a játék megkezdéséhez!
        </div>
    }
    else if (isLoading || currentSituation is null)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status"></div>
            <p class="mt-3 text-muted">Szituáció előkészítése...</p>
        </div>
    }
    else
    {
        <div class="situation" Situation="@currentSituation">

            @if (currentSituation.IllustrationUrl is not null && currentSituation.IllustrationUrl.Length > 0)
            {
                <img src="./src/Situations/@currentSituation.IllustrationUrl" alt="Illusztráció" class="situation-illustration" />
			}

            <div class="situation-text">
                <p class="title">@currentSituation.Title</p>

                @if (currentSituation.Text is not null && currentSituation.Text.Length > 0)
                {
                    <p class="text">@currentSituation.Text</p>
                }
            </div>

            @if (currentSituation is Info || currentSituation is Minigame)
            {
                <div class="continue-wrapper">
                    <button class="fancy-light" type="button" @onclick="ProceedAsync" disabled="@isProcessing">
                        <div class="shine" />
                        @(isProcessing ? "Máris..." : "Tovább →")
                    </button>
                </div>
            }
            else if (currentSituation is Decision)
            {
                <div class="choice-list decision-list">
                    @foreach (var choice in currentSituation.Choices)
                    {
                        var isChoiceTaken = IsChoiceTaken(choice);
                        <button class="choice-button" @onclick="() => HandleChoiceAsync(choice)" disabled="@isChoiceTaken">
                            <div class="shine" />
                            <span class="choice-text">@choice.Text</span>
                        </button>
                    }
                </div>
            }
            else if (currentSituation is Conversation)
            {
                <div class="choice-list conversation-list">
                    @foreach (var choice in currentSituation.Choices)
                    {
                        var isChoiceTaken = IsChoiceTaken(choice);
                        <button class="choice-button" @onclick="() => HandleChoiceAsync(choice)" disabled="@isChoiceTaken">
                            <div class="shine" />
                            <span class="choice-text">@choice.Text</span>
                        </button>
                    }
                </div>
            }
        </div>
    }

</div>

@code {
    private Player? player;
    private Situation? currentSituation;
    private bool isLoading = true;
    private bool isProcessing;

    private bool HasChoices => currentSituation?.Choices?.Any() == true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await EnsurePlayerAsync();
            if (player is not null)
            {
                await LoadSituationAsync();
            }
            else
            {
                Navigation.NavigateTo("/setup");
            }
        }
    }

    private async Task EnsurePlayerAsync()
    {
        if (GameState.CurrentPlayer is not null)
        {
            player = GameState.CurrentPlayer;
            return;
        }

        if (await GameState.RestorePlayerAsync())
        {
            player = GameState.CurrentPlayer;
            return;
        }


    }

    private async Task LoadSituationAsync()
    {
        if (player is null)
        {
            return;
        }

        isLoading = true;
        var situation = await GameService.GetCurrentSituationAsync(player);
        currentSituation = situation;
        isLoading = false;
        await InvokeAsync(StateHasChanged);
    }

    private bool IsChoiceTaken(Choice choice)
    {
        return player?.Decisions?.Any(d => d.ChoiceId == choice.Id) ?? false;
    }

    private void CheckCheckpoint()
    {
        if (currentSituation is null || currentSituation?.IsHalftime == true)
        {
            Navigation.NavigateTo("/results");
            return;
        }

        if (currentSituation?.IsTerminal == true)
        {
            Navigation.NavigateTo("/leaderboard");
            return;
        }
    }

    private async Task HandleChoiceAsync(Choice choice)
    {
        if (player is null || isProcessing || IsChoiceTaken(choice))
        {
            return;
        }

        isProcessing = true;

        try
        {
            player = await GameService.TakeChoiceAsync(player, choice.Id);
            await GameState.UpdatePlayerAsync(player);

            CheckCheckpoint();
            await LoadSituationAsync();
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task ProceedAsync()
    {
        if (player is null || isProcessing || currentSituation is null)
        {
            return;
        }

        isProcessing = true;

        try
        {
            player = await GameService.ProceedAsync(player, currentSituation.Id);
            await GameState.UpdatePlayerAsync(player);

            CheckCheckpoint();
            await LoadSituationAsync();
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void GoToResults()
    {
        if (player is not null)
        {
            Navigation.NavigateTo("/results");
            StateHasChanged();
        }
    }
}

