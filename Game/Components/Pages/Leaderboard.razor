@page "/leaderboard"
@rendermode InteractiveServer
@using Game.Models
@using Game.Services

@inject GameService GameService
@inject GameState GameState
@inject NavigationManager Navigation

<PageTitle>Rangsor</PageTitle>

<div class="main-container">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border"></div>
            <p>Dobpergés...</p>
        </div>
    }
    else if (GameState.CurrentPlayer is not null)
    {
        <section class="summary">
            <h1>Íme az eredmény:</h1>
            <p>@GetGeneralEvaluationText(GameState.CurrentPlayer.Stats)</p>
        </section>

        <section class="ranking">
            @foreach (var (entry, index) in GetFilteredLeaderboard())
            {
                var isCurrent = GameState.CurrentPlayer?.Id == entry.Id;
                <div class="rank-chip @(isCurrent ? "current-player" : "") @(index == 1 ? "first" : "")">
                    <div class="rank">@index</div>
                    <div class="username">@entry.Username</div>
                    <div class="score">
                        <div class="rank-shine" />
                        @entry.TotalScore
                    </div>
                </div>
            }
        </section>

        <section class="stat-evaluation">
            @foreach (KeyValuePair<string, (string Canonical, int Value, StatType Type)> stat in GameState.CurrentPlayer!.Stats.AsDictionary())
            {
                @if (stat.Value.Type != StatType.Energy && stat.Value.Type != StatType.Success)
                {
                    var iconPath = $"src/Icons/{stat.Value.Canonical.ToLower()}.png";
                    var cssClass = $"player-stat stat-{stat.Value.Canonical.ToLower()}";

                    <div class="evaluation-card">
                        <div class="@cssClass">
                            <div class="shine" />
                            <img src="@iconPath" class="stat-icon" />
                            <span class="value">@stat.Value.Value</span>
                        </div>
                        <h3>@stat.Key</h3>
                        <p>@GetStatEvaluationText(stat)</p>
                    </div>
                }
            }
        </section>
    }
</div>

@code {
    private readonly List<Player> entries = new();
    private bool isLoading = true;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await EnsurePlayerAsync();
            entries.Clear();
            entries.AddRange(await GameService.GetLeaderboardAsync());
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task EnsurePlayerAsync()
    {
        if (!await GameState.RestorePlayerAsync())
        {
            Navigation.NavigateTo("/setup", true);
            return;
        }
    }

    private IEnumerable<(Player entry, int index)> GetFilteredLeaderboard()
    {
        if (GameState.CurrentPlayer == null || entries.Count == 0)
            return Enumerable.Empty<(Player, int)>();

        var currentPlayerIndex = entries.FindIndex(p => p.Id == GameState.CurrentPlayer.Id);
        if (currentPlayerIndex == -1)
            return entries.Select((p, i) => (p, i + 1));

        var indicesToShow = new HashSet<int>();

        indicesToShow.Add(0);

        indicesToShow.Add(currentPlayerIndex);

        for (int i = Math.Max(0, currentPlayerIndex - 2); i < currentPlayerIndex; i++)
        {
            indicesToShow.Add(i);
        }

        for (int i = currentPlayerIndex + 1; i <= Math.Min(entries.Count - 1, currentPlayerIndex + 2); i++)
        {
            indicesToShow.Add(i);
        }

        return indicesToShow
            .OrderBy(i => i)
            .Select(i => (entries[i], i + 1));
    }

    private string GetStatEvaluationText(KeyValuePair<string, (string Canonical, int Value, StatType Type)> stat)
    {
        switch (stat.Value.Value)
        {
            case < 10:
                return Evaluation.GetEvaluation(stat.Value.Type, EvaluationLevel.Bad);
            case >= 15:
                return Evaluation.GetEvaluation(stat.Value.Type, EvaluationLevel.Good);
            default:
                return Evaluation.GetEvaluation(stat.Value.Type, EvaluationLevel.Average);
        };
    }

    private string GetGeneralEvaluationText(Stats stats)
    {
        switch (stats.Energy + stats.Success)
        {
            case < 45:
                return "Kevéssé jó! Kedves Játékos! A pontszámod alapján jösszességében nem túj jó teljesítménnyel zártad ezt a játékot, mert a végére alacsony pontszámod maradt. Ez azt jelenti, hogy a játék során több olyan döntést is hoztál, ami nagyon sok energiát emésztett fel, viszont alig sikerült vele növelned a hallgatói elégedettséget. A félév végére teljesen elfáradtál, leerültél és ennek ellenére nem sikerült elégedettebbé tenni a hallgatóidat.Arra érdemes figyelni, hogy bár fontos a hallgatói elégedettség, de az is fontos, hogy oktatóként ne használjuk fel, égessük el az összes energiánkat.";

            case >= 55:
                if (stats.Energy >= 15)
                    return "Kiváló! Kedves Játékos! Magas pontszámot, kiváló teljesítményt értél el a játékban, ami azt jelenti, hogy úgy értél el magas hallgatói elégedettséget, hogy viszonylag sok energiapontod meg is maradt. A játék folyamán tehát sok  olyan jó  döntést hoztál, ami kevesebb energiabefektetéssel magasabb hallgatói elégedettséget eredményezett.";
                else
                    return "Kiváló! Kedves Játékos! Magas pontszámot, kiváló teljesítményt értél el a játékban, ami azt jelenti, hogy magas hallgatói elégedettséget értél el, de kevés energiapontod maradt. Érdemes mérlegelni, hogy a hallgatói elégedettség persze fontos, de az is, hogy oktatóként maradjon elegendő erő és motiváltság.";

            default:
                return "Jó! Kedves Játékos! A pontszámod alapján jó teljesítményt értél el a játékban, azaz a hallgatói elégedettség is nőtt és energiapontod is maradt. Arra érdemes figyelni, hogy bár fontos a hallgatói elégedettség, de az is fontos, hogy oktatóként ne használjuk fel, égessük el az összes energiánkat. A  játékban hoztál olyan döntést is, ami több energiát emésztett fel, mint amennyi hasznot hozott.";
        };
    }
}

